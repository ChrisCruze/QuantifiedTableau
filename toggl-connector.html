<html>
  <head>
    <title>Rumble Capital Data Feed</title>
    <meta http-equiv="Cache-Control" content="no-store" />

    <link
      href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cruz.site44.com/js/jquery-3.1.1.min.js"></script>

    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
      integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
      crossorigin="anonymous"
    ></script>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.1.1.js" type="text/javascript"></script>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"
      integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg=="
      crossorigin="anonymous"
    ></script>
    <script src="https://rawgit.com/ChrisCruze/jutility/master/jutility.js"></script>
    <script src="https://chriscross.site44.com/js/jutility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.11.0/underscore-min.js"></script>
  </head>

  <body>
    <div class="container container-table">
      <div class="row vertical-center-row">
        <div class="text-center col-md-4 col-md-offset-4">
          <button type="button" id="submitButton" class="btn btn-success" style="margin: 10px;">Get Data</button>
        </div>
      </div>
    </div>
    <script>
      function toggl_time_fields(dur) {
        var minutes = parseFloat(dur) / 1000 / 60;
        var hours = minutes / 60;
        var cost = hours * 15;
        return { minutes, hours, cost };
      }

      function toggl_list_to_time_fields(list) {
        return _.map(list, function(obj) {
          return { ...obj, ...toggl_time_fields(obj.dur), date: moment(obj.end).format("YYYY-MM-DD") };
        });
      }

      function pullToggl({ updateData, api_token, user_agent, workspace_id }) {
        // var api_token = "4c2e7a7083b4434da3fda4fef989f353";
        return $.ajax({
          type: "GET",
          url: "https://toggl.com/reports/api/v2/details",
          headers: {
            Authorization: "Basic " + btoa(api_token + ":" + "api_token")
          },
          dataType: "json",
          async: false,
          data: {
            user_agent: user_agent || "vdermwcc@gmail.com",
            workspace_id: workspace_id || "2429477"
          }
        }).then(response => {
          var response_data = response.data;
          var response_data_with_time = toggl_list_to_time_fields(response_data);
          updateData(response_data_with_time);
        });
      }

      function pullTogglPageAll({ api_token, user_agent, workspace_id, toggl_list }) {
        const since = "2020-08-20";

        function pullTogglPage(toggl_tasks_pulled) {
          return new Promise(resolve => {
            const ajax_request = {
              type: "GET",
              url: "https://toggl.com/reports/api/v2/details",
              headers: {
                Authorization: "Basic " + btoa(api_token + ":" + "api_token")
              },
              dataType: "json",
              async: false,
              data: {
                user_agent: user_agent || "vdermwcc@gmail.com",
                workspace_id: workspace_id || "2429477",
                since: since,
                page: toggl_tasks_pulled.length == 0 ? 1 : Math.ceil(toggl_tasks_pulled.length / 50)
              }
            };
            console.log({ ajax_request });
            const result = $.ajax(ajax_request)
              .then(result => {
                console.log({ result });
                const response_data = result.data;
                console.log({ response_data });
                resolve(response_data);
              })
              .catch(error => {
                console.log({ error });
              });
          });
        }

        return pullTogglPage(toggl_list).then(result => {
          var iterate_to_next = toggl_list.length == 0 || toggl_list.length % 50 == 0;
          if (iterate_to_next) {
            var toggl_list_appended = toggl_list.concat(result);
            pullTogglPageAll({ api_token, user_agent, workspace_id, toggl_list: toggl_list_appended });
          } else {
            console.log({ toggl_list });
            return toggl_list;
          }
        });
      }
      (function() {
        // Create the connector object
        var myConnector = tableau.makeConnector();

        // Define the schema
        myConnector.getSchema = function(schemaCallback) {
          var cols = [
            {
              id: "description",
              dataType: tableau.dataTypeEnum.string
            },
            {
              id: "start",
              alias: "start",
              dataType: tableau.dataTypeEnum.string
            }
          ];

          var tableSchema = {
            id: "toggl",
            alias: "toggl",
            columns: cols
          };

          schemaCallback([tableSchema]);
        };

        // Download the data
        myConnector.getData = function(table, doneCallback) {
          pullTogglPageAll({
            api_token: "4c2e7a7083b4434da3fda4fef989f353",
            user_agent: "vdermwcc@gmail.com",
            workspace_id: "2429477",
            toggl_list: []
          }).then(feat => {
            tableData = [];
            for (var i = 0, len = feat.length; i < len; i++) {
              tableData.push({
                description: feat[i].description,
                start: feat[i].start
              });
            }
            table.appendRows(tableData);
            doneCallback();
          });
        };

        tableau.registerConnector(myConnector);
        // Create event listeners for when the user submits the form
        $(document).ready(function() {
          $("#submitButton").click(function() {
            tableau.connectionName = "Toggl"; // This will be the data source name in Tableau
            tableau.submit(); // This sends the connector object to Tableau
          });
        });
      })();
    </script>
  </body>
</html>
